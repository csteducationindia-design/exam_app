<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Exam Portal</title>
    
    <!-- PWA Links -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">
    
    <!-- APP ICONS: Added ?v=2 to force refresh -->
    <link rel="apple-touch-icon" href="/static/icon.png?v=2">
    <link rel="icon" type="image/png" href="/static/icon.png?v=2">
    
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <link rel="stylesheet" href="/static/css/tailwind.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #1e3a8a, #3b82f6, #14b8a6, #3b82f6);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .custom-option input[type="radio"] { display: none; }
        .custom-option label { background-color: #374151; border: 2px solid #4b5563; transition: all 0.2s ease-in-out; padding: 0.75rem 1rem; }
        .custom-option input[type="radio"]:checked + label {
            background-color: #3b82f6; border-color: #60a5fa;
            transform: translateY(-2px); box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .question-area {
            max-height: calc(100vh - 22rem);
            overflow-y: auto;
            padding-right: 1rem;
        }
        
        .question-nav-button {
            width: 2.5rem; height: 2.5rem; display: flex; align-items: center;
            justify-content: center; border-radius: 9999px;
            background-color: #4b5563; font-weight: 600; color: #d1d5db;
            transition: background-color 0.2s;
        }
        .question-nav-button.current { background-color: #3b82f6; color: #ffffff; }
        .question-nav-button.answered { background-color: #10b981; color: #ffffff; }
        .question-nav-button.reviewed { background-color: #f97316; color: #ffffff; }

    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-5xl bg-gray-900/60 backdrop-blur-xl border border-gray-700/50 rounded-2xl shadow-2xl text-gray-200 p-6 sm:p-8 space-y-6">

        <h1 id="main-title" class="text-3xl font-bold text-center text-white">Student Exam Login</h1>
        <p id="message-display" class="text-sm text-center font-medium h-5"></p>

        <div id="login-section" class="max-w-md mx-auto space-y-4">
            <input type="text" id="student-id-input" placeholder="Enter Your Student ID" class="w-full px-4 py-3 bg-gray-800 border-2 border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-white">
            <input type="text" id="exam-id-input" placeholder="Enter Exam ID" class="w-full px-4 py-3 bg-gray-800 border-2 border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-white">
            <button id="start-exam-button" class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all shadow-lg hover:shadow-blue-500/50 transform hover:-translate-y-0.5">Start Exam</button>
            
            <!-- Install App Button -->
            <button id="install-pwa-button" class="hidden w-full px-4 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors shadow-md mt-4">
                Install App ðŸ“±
            </button>
        </div>

        <div id="exam-section" class="hidden">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <div>
                    <h2 id="exam-title-display" class="text-2xl font-bold text-white"></h2>
                    <p id="student-name-display" class="text-sm font-medium text-gray-400"></p>
                </div>
                <div class="flex items-center space-x-2 text-right">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <div>
                        <p class="text-sm font-medium text-gray-400">Time Remaining</p>
                        <p id="time-display" class="text-xl font-bold text-red-400"></p>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6">
                <div class="flex-grow space-y-4 question-area">
                    <img id="question-image" class="rounded-lg shadow-md mb-4 hidden w-full h-auto object-contain max-h-80" alt="Question image">
                    <div class="bg-gray-800/80 p-6 rounded-lg shadow-inner border border-gray-700">
                        <p id="question-text" class="text-lg font-medium text-gray-100"></p>
                    </div>
                    <div id="options-container" class="space-y-3"></div>
                </div>

                <div id="nav-panel-container" class="w-full md:w-64 flex-shrink-0 bg-gray-900/60 backdrop-blur-xl border border-gray-700/50 rounded-xl p-4">
                    <h3 class="text-lg font-bold text-center text-white">Exam Overview</h3>
                    <div class="text-sm mt-2 text-center text-gray-400">Total Questions: <span id="total-questions-display" class="font-bold text-white"></span></div>
                    
                    <div class="grid grid-cols-3 gap-2 my-4 text-center">
                        <div>
                            <div id="answered-count" class="font-bold text-2xl text-green-400">0</div>
                            <div class="text-xs text-gray-400">Answered</div>
                        </div>
                        <div>
                            <div id="unanswered-count" class="font-bold text-2xl text-gray-400">0</div>
                            <div class="text-xs text-gray-400">Unanswered</div>
                        </div>
                        <div>
                            <div id="reviewed-count" class="font-bold text-2xl text-yellow-400">0</div>
                            <div class="text-xs text-gray-400">For Review</div>
                        </div>
                    </div>
                    <div id="question-nav-panel" class="grid grid-cols-5 gap-2 p-2 mt-2 bg-gray-800/50 rounded-lg shadow-inner max-h-64 overflow-y-auto"></div>
                </div>
            </div>

            <div id="bottom-bar" class="fixed bottom-0 left-0 right-0 bg-gray-900/80 backdrop-blur-sm border-t border-gray-700 p-4 flex justify-between items-center">
                <button id="prev-question-button" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors shadow-md hidden">Previous</button>
                <div class="flex space-x-2">
                    <button id="mark-for-review-button" class="px-6 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition-colors shadow-md">Mark for Review</button>
                    <button id="save-answer-button" class="px-6 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors shadow-md">Save & Next</button>
                </div>
                <button id="next-question-button" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md">Next</button>
                <button id="end-exam-button" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors shadow-md">End Exam</button>
            </div>
        </div>
        
        <div id="results-section" class="hidden text-center space-y-4">
            <h2 class="text-3xl font-bold text-white">Exam Results</h2>
            <div class="w-40 h-40 mx-auto relative my-8">
                <svg class="w-full h-full transform -rotate-90">
                    <circle class="text-gray-700" stroke-width="8" stroke="currentColor" fill="transparent" r="70" cx="80" cy="80"/>
                    <circle id="score-circle" class="text-blue-500" stroke-width="8" stroke="currentColor" fill="transparent" r="70" cx="80" cy="80" style="transition: stroke-dashoffset 0.3s linear;"/>
                </svg>
                <p id="final-score-display" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl font-bold text-white"></p>
            </div>
            <p id="pass-fail-message" class="text-2xl font-bold"></p>
            <p id="attempt-info-display" class="text-sm font-medium text-gray-400"></p>
            <div class="mt-6">
                <button id="view-report-button" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md hidden">View Analysis Report</button>
                <button id="view-certificate-button" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors shadow-md hidden">View Certificate</button>
            </div>
            <div id="analysis-report-container" class="mt-8 hidden">
                <h3 class="text-xl font-bold text-white">Analysis Report</h3>
                <div class="mt-4 overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700 rounded-lg">
                        <thead>
                            <tr class="text-left text-gray-400">
                                <th class="py-3 px-4">#</th>
                                <th class="py-3 px-4">Question</th>
                                <th class="py-3 px-4">Status</th>
                                <th class="py-3 px-4">Your Answer</th>
                                <th class="py-3 px-4">Correct Answer</th>
                            </tr>
                        </thead>
                        <tbody id="analysis-report-body" class="divide-y divide-gray-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="certificate-section" class="hidden"></div>
    </div>

<script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log('SW registered!', reg))
          .catch(err => console.log('SW failed', err));
      });
    }

    // Install Prompt Logic
    let deferredPrompt;
    const installButton = document.getElementById('install-pwa-button');

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installButton.classList.remove('hidden');
    });

    installButton.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                installButton.classList.add('hidden');
            }
            deferredPrompt = null;
        }
    });

    const app = {
        studentId: null, examId: null, teacherId: null, examData: null,
        currentQuestionIndex: 0, answers: {}, questionStatus: {},
        timeLeft: 0, timer: null, progressSaver: null, analysisReportData: null,
        finalScore: 0,

        init: () => {
            document.getElementById('start-exam-button').addEventListener('click', app.startExam);
            document.getElementById('next-question-button').addEventListener('click', () => app.changeQuestion('next'));
            document.getElementById('prev-question-button').addEventListener('click', () => app.changeQuestion('prev'));
            document.getElementById('save-answer-button').addEventListener('click', app.saveAndNext);
            document.getElementById('mark-for-review-button').addEventListener('click', app.markForReview);
            document.getElementById('end-exam-button').addEventListener('click', () => {
                if (confirm('Are you sure you want to end the exam? This action cannot be undone.')) {
                    app.submitExam();
                }
            });
            
            document.getElementById('view-report-button').addEventListener('click', app.toggleReportVisibility);
            document.getElementById('view-certificate-button').addEventListener('click', app.viewCertificate);
        },
        
        saveAndNext: () => {
            const qText = app.examData.questions[app.currentQuestionIndex].question_text;
            if (app.answers[qText]) {
                if (app.questionStatus[qText] !== 'reviewed') {
                    app.questionStatus[qText] = 'answered';
                }
                app.showMessage('Answer saved!', 'green');
                app.renderQuestionList(); 
                app.changeQuestion('next');
            } else {
                app.showMessage('Please select an option to save.', 'red');
            }
        },
        
        markForReview: () => {
            const qText = app.examData.questions[app.currentQuestionIndex].question_text;
            if (app.questionStatus[qText] === 'reviewed') {
                app.questionStatus[qText] = app.answers[qText] ? 'answered' : undefined;
                app.showMessage('Question un-marked from review.', 'gray');
            } else {
                app.questionStatus[qText] = 'reviewed';
                app.showMessage('Question marked for review!', 'orange');
            }
            app.renderQuestionList();
        },

        renderQuestionList: () => {
            const navPanel = document.getElementById('question-nav-panel');
            navPanel.innerHTML = '';
            let answeredCount = 0;
            let reviewedCount = 0;
            const totalQuestions = app.examData.questions.length;

            app.examData.questions.forEach((q, index) => {
                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = 'question-nav-button';
                button.dataset.index = index;

                if (index === app.currentQuestionIndex) {
                    button.classList.add('current');
                }
                
                const status = app.questionStatus[q.question_text];
                
                if (status === 'reviewed') {
                    button.classList.add('reviewed');
                    reviewedCount++;
                } else if (status === 'answered') {
                    button.classList.add('answered');
                    answeredCount++;
                }
                
                button.onclick = () => {
                    app.currentQuestionIndex = index;
                    app.renderQuestion();
                    app.renderQuestionList();
                };
                navPanel.appendChild(button);
            });

            const unansweredCount = totalQuestions - answeredCount - reviewedCount;
            document.getElementById('total-questions-display').textContent = totalQuestions;
            document.getElementById('answered-count').textContent = answeredCount;
            document.getElementById('reviewed-count').textContent = reviewedCount;
            document.getElementById('unanswered-count').textContent = unansweredCount;
        },
        
        toggleReportVisibility: () => { const reportContainer = document.getElementById('analysis-report-container'); const reportButton = document.getElementById('view-report-button'); if (reportContainer) { const isHidden = reportContainer.classList.toggle('hidden'); reportButton.textContent = isHidden ? 'View Analysis Report' : 'Hide Report'; } },
        
        showMessage: (message, color) => { 
            const element = document.getElementById('message-display'); 
            element.textContent = message; 
            const colorMap = { red: 'text-red-400', green: 'text-green-400', blue: 'text-blue-400', gray: 'text-gray-400', orange: 'text-yellow-400' }; 
            element.className = `text-sm text-center font-medium h-5 ${colorMap[color] || 'text-gray-400'}`; 
        },

        startExam: async () => { 
            const studentId = document.getElementById('student-id-input').value.trim(); 
            const examId = document.getElementById('exam-id-input').value.trim(); 
            const startButton = document.getElementById('start-exam-button'); 
            
            if (!studentId || !examId) {
                return app.showMessage('Student ID and Exam ID are required.', 'red');
            }
            
            startButton.disabled = true; 
            startButton.textContent = 'Loading...'; 
            app.showMessage('Checking eligibility...', 'gray'); 
            
            try { 
                const response = await fetch('/api/exam/start', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ student_id: studentId, exam_id: examId }) 
                }); 
                const result = await response.json(); 
                
                if (!response.ok) {
                    throw new Error(result.message);
                }

                Object.assign(app, { 
                    studentId, examId, 
                    studentName: result.student_name, 
                    teacherId: result.teacher_id, 
                    examData: result.exam_data, 
                    answers: result.exam_data.answers || {}, 
                    questionStatus: result.exam_data.question_status || {}, 
                    timeLeft: result.exam_data.time_left 
                }); 
                
                document.getElementById('main-title').textContent = "Exam in Progress"; 
                document.getElementById('login-section').classList.add('hidden'); 
                document.getElementById('exam-section').classList.remove('hidden'); 
                document.getElementById('exam-title-display').textContent = app.examData.exam_title; 
                document.getElementById('student-name-display').textContent = `Student: ${app.studentName}`; 
                app.renderQuestion(); 
                app.renderQuestionList(); 
                app.startTimer(); 
                app.startProgressSaver(); 
            } catch (error) { 
                document.getElementById('main-title').textContent = 'Error!';
                document.getElementById('message-display').textContent = error.message || 'An unexpected error occurred. Please contact your teacher.';
                document.getElementById('message-display').className = 'text-lg text-center font-bold text-red-500 my-4';
                
                startButton.disabled = false; 
                startButton.textContent = 'Start Exam'; 
            } 
        },
        startTimer: () => { app.timer = setInterval(() => { app.timeLeft--; document.getElementById('time-display').textContent = app.formatTime(app.timeLeft); if (app.timeLeft <= 0) { clearInterval(app.timer); app.showMessage('Time is up! Submitting exam...', 'red'); app.submitExam(true); } }, 1000); document.getElementById('time-display').textContent = app.formatTime(app.timeLeft); },
        startProgressSaver: () => { app.progressSaver = setInterval(() => { fetch('/api/save-progress', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ student_id: app.studentId, exam_id: app.examId, teacher_id: app.teacherId, answers: app.answers, time_left: app.timeLeft, question_status: app.questionStatus }) }); }, 15000); },
        formatTime: (seconds) => `${Math.floor(seconds / 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`,
        renderQuestion: () => { 
            const question = app.examData.questions[app.currentQuestionIndex]; 
            document.getElementById('question-text').textContent = `${app.currentQuestionIndex + 1}. ${question.question_text}`; 
            const img = document.getElementById('question-image'); 
            img.classList.toggle('hidden', !question.image_url); 
            if (question.image_url) img.src = question.image_url; 
            const optionsContainer = document.getElementById('options-container'); 
            optionsContainer.innerHTML = ''; 
            const selectedAnswer = app.answers[question.question_text] || null; 
            for (const [key, value] of Object.entries(question.options)) { 
                const isSelected = selectedAnswer === key; 
                const optionDiv = document.createElement('div'); 
                optionDiv.className = 'custom-option'; 
                optionDiv.innerHTML = `<input type="radio" id="option-${key}" name="question-${app.currentQuestionIndex}" value="${key}" ${isSelected ? 'checked' : ''}><label for="option-${key}" class="block w-full p-4 rounded-lg cursor-pointer">${key}. ${value}</label>`; 
                optionDiv.querySelector('input').onchange = () => app.selectAnswer(key); 
                optionsContainer.appendChild(optionDiv); 
            } 
            document.getElementById('prev-question-button').classList.toggle('hidden', app.currentQuestionIndex === 0); 
            document.getElementById('next-question-button').classList.toggle('hidden', app.examData.questions.length <= 1 || app.currentQuestionIndex === app.examData.questions.length - 1); 
        },
        selectAnswer: (selectedOption) => { app.answers[app.examData.questions[app.currentQuestionIndex].question_text] = selectedOption; },
        changeQuestion: (direction) => { const canMove = (direction === 'next' && app.currentQuestionIndex < app.examData.questions.length - 1) || (direction === 'prev' && app.currentQuestionIndex > 0); if (canMove) { app.currentQuestionIndex += (direction === 'next' ? 1 : -1); app.renderQuestion(); app.renderQuestionList(); } },
        submitExam: async () => { clearInterval(app.timer); clearInterval(app.progressSaver); app.showMessage('Submitting exam...', 'blue'); const response = await fetch('/api/submit/exam', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ exam_id: app.examId, student_id: app.studentId, student_name: app.studentName, teacher_id: app.teacherId, answers: app.answers }) }); const result = await response.json(); if (response.ok) { app.analysisReportData = result.analysis_report; app.endExam(result.score); } else { app.showMessage(result.message || 'Submission error.', 'red'); } },
        endExam: (score) => { 
            document.getElementById('exam-section').classList.add('hidden'); 
            document.getElementById('results-section').classList.remove('hidden'); 
            document.getElementById('main-title').textContent = "Exam Results"; 
            app.finalScore = score; 
            const totalQuestions = app.examData.questions.length; 
            const percentage = totalQuestions > 0 ? (score / totalQuestions) * 100 : 0; 
            document.getElementById('attempt-info-display').textContent = `Attempt ${app.examData.attempt_number} of ${app.examData.allowed_attempts}`; 
            document.getElementById('final-score-display').textContent = `${score}/${totalQuestions}`; 
            const passFailMessage = document.getElementById('pass-fail-message'); 
            const passed = percentage >= app.examData.passing_percentage; 
            passFailMessage.textContent = passed ? 'Congratulations, you have passed!' : 'Sorry, you have not passed.'; 
            passFailMessage.className = `text-2xl font-bold ${passed ? 'text-green-400' : 'text-red-400'}`; 
            const circle = document.getElementById('score-circle'); 
            const radius = circle.r.baseVal.value; 
            const circumference = 2 * Math.PI * radius; 
            const offset = circumference - (percentage / 100) * circumference; 
            circle.style.strokeDashoffset = offset; 
            circle.style.stroke = passed ? '#22c55e' : '#ef4444'; 
            if (app.examData.enable_analysis_report) { 
                document.getElementById('view-report-button').classList.remove('hidden'); 
                document.getElementById('view-report-button').addEventListener('click', app.toggleReportVisibility);
                app.renderAnalysisReport(); 
            } 
        },
        renderAnalysisReport: () => { 
            if (!app.analysisReportData) return; 
            const analysisBody = document.getElementById('analysis-report-body'); 
            analysisBody.innerHTML = ''; 
            app.analysisReportData.forEach((q, index) => { 
                const studentAnswerText = q.options[q.student_answer] || 'Not Answered'; 
                const correctAnswerText = q.options[q.correct_answer]; 
                const row = document.createElement('tr'); 
                row.className = `border-b border-gray-700 ${q.is_correct ? 'bg-green-600/10' : 'bg-red-600/10'}`; 
                row.innerHTML = `<td class="py-3 px-4">${index + 1}</td><td class="py-3 px-4">${q.question_text}</td><td class="py-3 px-4 font-semibold ${q.is_correct ? 'text-green-400' : 'text-red-400'}">${q.is_correct ? 'Correct' : 'Incorrect'}</td><td class="py-3 px-4">${studentAnswerText}</td><td class="py-3 px-4">${correctAnswerText}</td>`; 
                analysisBody.appendChild(row); 
            }); 
        },
        viewCertificate: () => {
             // Certificate generation logic here
        },
        closeCertificate: () => {
            // Logic to close certificate
        }
    };
    
    document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>